---
import type { GetStaticPaths } from "astro";
import Layout from "../layouts/Layout.astro";
import { CATEGORIES, PAGE_SIZE, type Category } from "../config";
import { getCollection } from "astro:content";
import PostCardList from "../components/PostCardList.astro";
import Pagination from "../components/Pagination.astro";
import { getPostHref } from "../utils/posts";

export const getStaticPaths: GetStaticPaths = () => {
	return Object.keys(CATEGORIES).map((category) => ({
		params: { category },
	}));
};

const { category } = Astro.params;
const categoryName = CATEGORIES[category as Category];

const posts = (await getCollection("blog"))
	.filter((post) => !post.data.draft)
	.filter((post) => post.data.category === category)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const totalPages = Math.max(1, Math.ceil(posts.length / PAGE_SIZE));
const pagePosts = posts.slice(0, PAGE_SIZE);

const items = pagePosts.map((post) => ({
	title: post.data.title,
	href: getPostHref(post),
	date: post.data.pubDate,
	description: post.data.description,
	image: post.data.image,
	imageAlt: post.data.imageAlt,
}));
---

<Layout title={categoryName} description={`${categoryName}相關文章`}>
	<section class="p-10">
		<div class="space-y-20">
			<PostCardList items={items} />
			<Pagination
				currentPage={1}
				totalPages={totalPages}
				basePath={`/${category}`}
				pagePath={`/${category}/page`}
			/>
		</div>
	</section>
</Layout>
